; 18649 Fall 2013
; Group 17
; Qiang Zhang(qiangz)/Shen Yu(sheny)/Jiang He(jiangh)/Xianle Wang(xianlew)
; sd8a.mf


;network message period
#DEFINE MESSAGE_PERIOD 10ms

#DEFINE AT_FLOOR_[1][FRONT]_CAN_ID 0xC4D6F00
#DEFINE AT_FLOOR_[1][BACK]_CAN_ID 0xC4D6F01
#DEFINE AT_FLOOR_[2][BACK]_CAN_ID 0xC4D6F03
#DEFINE AT_FLOOR_[3][FRONT]_CAN_ID 0xC4D6F04
#DEFINE AT_FLOOR_[4][FRONT]_CAN_ID 0xC4D6F06
#DEFINE AT_FLOOR_[5][FRONT]_CAN_ID 0xC4D6F08
#DEFINE AT_FLOOR_[6][FRONT]_CAN_ID 0xC4D6F0A
#DEFINE AT_FLOOR_[7][FRONT]_CAN_ID 0xC4D6F0C
#DEFINE AT_FLOOR_[7][BACK]_CAN_ID 0xC4D6F0D
#DEFINE AT_FLOOR_[8][FRONT]_CAN_ID 0xC4D6F0E

#DEFINE DOOR_MOTOR_COMMAND_[FRONT][LEFT]_CAN_ID 0x0BEA6500
#DEFINE DOOR_MOTOR_COMMAND_[FRONT][RIGHT]_CAN_ID 0x0BEA6501
#DEFINE DOOR_MOTOR_COMMAND_[BACK][LEFT]_CAN_ID 0x0BEA6502
#DEFINE DOOR_MOTOR_COMMAND_[BACK][RIGHT]_CAN_ID 0x0BEA6503

;mDesiredFloor
#DEFINE DESIRED_FLOOR_CAN_ID                           0x0C4E7000

;mDoorClosed
#DEFINE DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID        0x0CB27900
#DEFINE DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID       0x0CB27901
#DEFINE DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID         0x0CB27902
#DEFINE DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID        0x0CB27903

;mDrive
#DEFINE DRIVE_COMMAND_CAN_ID						   0x0BE96400
;mDriveSpeed
#DEFINE DRIVE_SPEED_CAN_ID                             0x0BE86400

;mDoorOpened
#DEFINE DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID          0x0D157C00
#DEFINE DOOR_OPEN_SENSOR_[FRONT][RIGHT]_CAN_ID         0x0D157C01
#DEFINE DOOR_OPEN_SENSOR_[BACK][LEFT]_CAN_ID           0x0D157C02
#DEFINE DOOR_OPEN_SENSOR_[BACK][RIGHT]_CAN_ID          0x0D157C03

;mCarWeight = 0x0D187E00
#DEFINE CAR_WEIGHT_CAN_ID  0x0D187E00

;mLevel
#DEFINE LEVEL_SENSOR_[UP]_CAN_ID 0x09F40A00
#DEFINE LEVEL_SENSOR_[DOWN]_CAN_ID 0x09F40A01

;mEmergencyBrake
#DEFINE EMERGENCY_BRAKE_CAN_ID	0x0C4C6E00

;mHoistwayLimit
#DEFINE HOISTWAY_LIMIT_[UP]_CAN_ID	0x0D147B00
#DEFINE HOISTWAY_LIMIT_[DOWN]_CAN_ID	0x0D147B01

#DEFINE HALLCALL_1FU_CAN_ID 0x0CB17800
#DEFINE HALLCALL_7FU_CAN_ID 0x0CB17818
#DEFINE HALLCALL_8FD_CAN_ID 0x0CB1781D


;Car Level Position
#DEFINE CAR_LEVEL_CAN_ID 0x0C517200

;intialize 
0s I MESSAGE_PERIOD N HALLCALL_1FU_CAN_ID HallCall 1 FRONT UP = true
0s I MESSAGE_PERIOD N HALLCALL_7FU_CAN_ID HallCall 7 FRONT UP = false
0s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = true
0s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID DoorClosed FRONT RIGHT = true
0s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = true
0s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = true

0s I MESSAGE_PERIOD N AT_FLOOR_[1][FRONT]_CAN_ID AtFloor 1 FRONT = true
0s I MESSAGE_PERIOD N AT_FLOOR_[2][BACK]_CAN_ID AtFloor 2 BACK = false
0s I MESSAGE_PERIOD N AT_FLOOR_[3][FRONT]_CAN_ID AtFloor 3 FRONT = false
0s I MESSAGE_PERIOD N AT_FLOOR_[4][FRONT]_CAN_ID AtFloor 4 FRONT = false
0s I MESSAGE_PERIOD N AT_FLOOR_[5][FRONT]_CAN_ID AtFloor 5 FRONT = false
0s I MESSAGE_PERIOD N AT_FLOOR_[6][FRONT]_CAN_ID AtFloor 6 FRONT = false
0s I MESSAGE_PERIOD N AT_FLOOR_[7][FRONT]_CAN_ID AtFloor 7 FRONT = false
0s I MESSAGE_PERIOD N AT_FLOOR_[8][FRONT]_CAN_ID AtFloor 8 FRONT = false

0s I MESSAGE_PERIOD N LEVEL_SENSOR_[UP]_CAN_ID Leveling UP = false
0s I MESSAGE_PERIOD N LEVEL_SENSOR_[DOWN]_CAN_ID Leveling DOWN = false

;trigger DoorMotor to OPEN
;#arc '8A/1a'
1s I MESSAGE_PERIOD N AT_FLOOR_[1][FRONT]_CAN_ID AtFloor 1 FRONT = true
1s I MESSAGE_PERIOD N LEVEL_SENSOR_[UP]_CAN_ID Leveling UP = true
1s I MESSAGE_PERIOD N LEVEL_SENSOR_[DOWN]_CAN_ID Leveling DOWN = true

;trigger mDesiredFloor to change
1.5s I MESSAGE_PERIOD N HALLCALL_1FU_CAN_ID HallCall 1 FRONT UP = false
1.5s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = false
1.5s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID DoorClosed FRONT RIGHT = false
1.5s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = false
1.5s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = false

2.3s A F DoorMotor FRONT LEFT : command == OPEN

2.5s I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[FRONT][LEFT]_CAN_ID DoorOpened FRONT LEFT = true
2.5s I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[FRONT][RIGHT]_CAN_ID DoorOpened FRONT RIGHT = true
2.5s I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[BACK][LEFT]_CAN_ID DoorOpened BACK LEFT = true
2.5s I MESSAGE_PERIOD N DOOR_OPEN_SENSOR_[BACK][RIGHT]_CAN_ID DoorOpened BACK RIGHT = true

;#arc '8A/2'
7.0s A F DoorMotor FRONT LEFT : command == CLOSE

;#arc '8A/3a'
8s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = true
8s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID DoorClosed FRONT RIGHT = true
8s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = true
8s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = true

;#arc '8A/3b'
8.2s A F DoorMotor FRONT LEFT : command == STOP
8.2s A F DoorMotor FRONT RIGHT : command == STOP
8.2s A F DoorMotor BACK LEFT : command == STOP
8.2s A F DoorMotor BACK RIGHT : command == STOP

;#arc '8A/7a'
8.5s I MESSAGE_PERIOD N CAR_LEVEL_CAN_ID CarLevelPosition = 0

;#arc '8A/4a'
9.0s I MESSAGE_PERIOD N HALLCALL_7FU_CAN_ID HallCall 7 FRONT UP = true
9.3s A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == UP
9.3s A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 7

;#arc '8A/4b'
9.4s A F Drive : speed == SLOW
9.4s A F Drive : direction == UP

;#arc '8A/7b'
9.5s I MESSAGE_PERIOD N CAR_LEVEL_CAN_ID CarLevelPosition = 100

;#arc '8A/4c'
9.5s I MESSAGE_PERIOD F DriveSpeed = UP 0.3
10s A F Drive : speed == FAST
10s A F Drive : direction == UP

;#arc '8A/7c'
14s I MESSAGE_PERIOD N CAR_LEVEL_CAN_ID CarLevelPosition = 29500

;#arc '8A/4d'
14s I MESSAGE_PERIOD F DriveSpeed = UP 0.15
14.5s A F Drive : speed == SLOW
14.5s A F Drive : direction == UP


;#arc '8A/5a'
15s I MESSAGE_PERIOD N AT_FLOOR_[1][FRONT]_CAN_ID AtFloor 1 FRONT = false
15s I MESSAGE_PERIOD N AT_FLOOR_[7][FRONT]_CAN_ID AtFloor 7 FRONT = true
15s I MESSAGE_PERIOD N LEVEL_SENSOR_[UP]_CAN_ID Leveling UP = false
15s I MESSAGE_PERIOD N LEVEL_SENSOR_[DOWN]_CAN_ID Leveling DOWN = false

;#arc '8A/5b'
15s I MESSAGE_PERIOD N LEVEL_SENSOR_[UP]_CAN_ID Leveling UP = false
15s I MESSAGE_PERIOD N LEVEL_SENSOR_[DOWN]_CAN_ID Leveling DOWN = false
15s I MESSAGE_PERIOD N HALLCALL_7FU_CAN_ID HallCall 7 FRONT UP = false
15.2s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = false

;#arc '8A/5c'
16s A F Drive : speed == LEVEL
16s A S DriveControl : STATE == LEVEL_UP

;#arc '8A/5d'
17s I MESSAGE_PERIOD N LEVEL_SENSOR_[UP]_CAN_ID Leveling UP = true
17s I MESSAGE_PERIOD N LEVEL_SENSOR_[DOWN]_CAN_ID Leveling DOWN = true

;#arc '8A/5e'
17.5s A F Drive : speed == STOP

;#arc '8A/6a'
18s I MESSAGE_PERIOD N HALLCALL_8FD_CAN_ID HallCall 8 FRONT DOWN = true
18s I MESSAGE_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = true
18s I MESSAGE_PERIOD N AT_FLOOR_[7][FRONT]_CAN_ID AtFloor 7 FRONT = false
18.5s A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 8
18.5s A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == DOWN
20s A S DriveControl : STATE == SLOW_UP
20s A F Drive : speed == SLOW
20s A F Drive : direction == UP


;#arc '8A/6b'
20s I MESSAGE_PERIOD N EMERGENCY_BRAKE_CAN_ID Boolean = true

;#arc '8A/6c'
20s I MESSAGE_PERIOD N AT_FLOOR_[8][FRONT]_CAN_ID AtFloor 8 FRONT = true
21s A F Drive : speed == STOP
21s A F Drive : direction == STOP

;****verify postcondition
25s A N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT : getValue == true
25s A F DoorMotor FRONT LEFT : command == STOP


